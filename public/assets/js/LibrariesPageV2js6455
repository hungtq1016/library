"use strict";var OverDrive=OverDrive||{};OverDrive.Mapbox=function(n){var t=n||{},i=null,r={},y=null,a=25,p=null,w="none",e=null,s=null,u=null,tt=0,o=!0,b=!1,ft=!1,it=!0,et=function(r,u=false){var o,f,c;L.mapbox.accessToken="pk.eyJ1Ijoib3ZlcmRyaXZlIiwiYSI6ImFKMV95VTgifQ.Qah-R0_OIXc9D129-0-J9w";o=[40,-74.5];n.defaultLocation&&(o=[n.defaultLocation.lat,n.defaultLocation.lng]);f=L.mapbox.map("map",null,{maxZoom:t.maxZoom,minZoom:t.minZoom,attributionControl:!1}).addLayer(L.mapbox.styleLayer("mapbox://styles/overdrive/ckasbdlz14uis1it7w9h26fl2")).whenReady(function(){t.query&&(t.$searchInput.val(t.query),t.$searchBtn.click())});c=L.control.attribution().addTo(f);c.addAttribution('<a href="/fine-print/attributions">Improve this map<\/a>');f.on("moveend",function(){wt(f);l(f,"move end")});i=f;e=r;s=e.parent();tt=500;k();t.query||u?u&&h(o[0],o[1],{autoSize:!0,minHitCount:a}):pt(function(n,t){h(n,t,{autoSize:!0,minHitCount:a})});ot();st();ht();ct();lt();at();$(window).resize(function(){k()})},rt=function(n=false){var r=t.$searchInput.val(),u;r?(g(i),t.$searchInput.blur(),window.OverDrive.searchLibrariesByQuery?l(i,"query search"):o?(u=L.mapbox.geocoder("mapbox.places-v1"),u.query(r,function(n,r){r.latlng?i.setView([r.latlng[0],r.latlng[1]],t.minZoom+Math.floor((t.maxZoom-t.minZoom)/2)):r.lbounds?i.fitBounds(r.lbounds):f("/mapbox/no-matches-found/")})):l(i,"name search")):r===""&&n&&(g(i),l(i,"name search"))},ot=function(){t.$searchBtn&&t.$searchInput&&t.$searchBtn.click(function(n){n.preventDefault();rt()})},st=function(){t.$viewToggle.length!==0&&(b=t.$viewToggle[0].checked,o=t.$viewToggle[1].checked,t.$viewToggle&&t.$viewToggle.click(function(n){var r=$(n.target).val();o=r=="location";b=r=="name";t.$searchInput.attr("placeholder",o?"Enter a ZIP code or location":"Enter a library name");ft&&(g(i),l(i,"type toggle"))}))},ht=function(){t.$mapToggle.on("click",function(){s.height("");s.height(null);s.toggleClass("map--open");s.toggleClass("map--closed");k();i.invalidateSize({pan:!1})})},ct=function(){e.parent().on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(n){n.target===n.currentTarget&&i.invalidateSize({pan:!1})})},lt=function(){var n=$('.map-tools__item[data-action="zoom-in"]'),t=$('.map-tools__item[data-action="zoom-out"]');n&&n.length>0&&n.click(function(n){i.zoomIn();n.stopPropagation()});t&&t.length>0&&t.click(function(n){i.zoomOut();n.stopPropagation()})},at=function(){var n=$('.map-tools__item[data-action="locate"]');n&&n.length>0&&n.click(function(n){ut(function(n,t){h(n,t,{autoSize:!0,minHitCount:a})});n.stopPropagation()})},k=function(){e.parent().hasClass("map--closed")||e.parent().height(Math.min(tt,$(window).height()*.75))},vt=function(){i.dragging.disable();i.touchZoom.disable();i.doubleClickZoom.disable();i.scrollWheelZoom.disable();i.tap&&i.tap.disable()},yt=function(){i.dragging.enable();i.touchZoom.enable();i.doubleClickZoom.enable();i.scrollWheelZoom.enable();i.tap&&i.tap.enable()},pt=function(n){typeof n=="function"&&d(n)},ut=function(n){typeof n=="function"&&(navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){w="browser";n(t.coords.latitude,t.coords.longitude)},function(){d(n)}):d(n))},d=function(n){$.get("/mapbox/get-user-location-by-ip/?ip="+t.testIp).done(function(t){t&&t.isValid?(w="ip",n(t.latitude,t.longitude)):(console.log("Invalid location detected"),f("/mapbox/could-not-locate/"))}).fail(function(){console.log("Failed to get location from IP.");f("/mapbox/could-not-locate/")})},h=function(n,r,u){u.autoSize&&u.minHitCount&&$.getJSON("/mapbox/get-default-bounds?latLng="+n+","+r+"&minHitCount="+u.minHitCount+"&detectionMethod="+w).done(function(n){n.success?(p=ri(n.bounds),i.fitBounds(p)):(i.setView(L.latLng(n.lat,n.lng),t.minZoom),console.log("Failed to find libraries near current location."))}).fail(function(){console.log("Failed to get default geographic bounds.")})},g=function(n){var i,u;for(i in r)if(t.cluster)n.removeLayer(r[i].cluster);else for(u=0;u<r[i].markers.length;u++)n.removeLayer(r[i].markers[u]);r={}},wt=function(n){var e=n.getBounds(),f,u,i;y&&e.extend(y.getLatLng());for(f in r)if(r.hasOwnProperty(f))for(u=r[f].markers,i=0;i<u.length;i++)e.contains(u[i].getLatLng())||(t.cluster?r[f].cluster.removeLayer(u[i]):n.removeLayer(u[i]),u.splice(i--,1))},nt=function(n,i,u,e){var h,s,o;if(!n)for(h=r[i],s=h.markers,o=0;o<s.length&&n==null;o++)s[o].options.data.id===u&&(n=s[o]);if(n){if(n.getLatLng().lat===0&&n.getLatLng().lng===0){f("/mapbox/location-not-set/");return}y=n;ii(n.getPopup(),n.options.data.id,n.options.data.markerColor);e&&n.openPopup()}t.selected&&n&&t.selected(n.options.data)},c=null,bt=function(n){Object.assign(t,n)},l=function(n,i){c&&c.abort();var e=typeof t.radius!="undefined"?t.radius:gt(n),u="";u=i=="query search"?`/mapbox/find-libraries-by-query?query=${t.$searchInput.val()}`:b?"/mapbox/find-libraries-by-name?name="+t.$searchInput.val():"/mapbox/find-libraries-by-location?latLng="+dt(n)+"&radius="+e;typeof t.includePublicLibraries!="undefined"&&typeof t.includeSchoolLibraries!="undefined"&&(u+="&includePublicLibraries="+!!t.includePublicLibraries+"&includeSchoolLibraries="+!!t.includeSchoolLibraries);typeof t.sort!="undefined"&&(u+="&sort="+t.sort);c=$.getJSON(u).done(function(u){var e,s,v,l,a;if(u.length===0){f("/mapbox/no-matches-found/");c=null;return}for(e=0;e<u.length;e++)s=r[u[e].consortiumId]||ti(n),v=s.markerColor.substr(1,6),u[e].consortiumColor=s.markerColor,$.each(u[e].geoJson,function(i,r){var o,f;if(!s.containsMarker(r)){o="";window.OverDrive.usingV2LibrariesPage&&window.OverDrive.usingV2LibrariesPage===!0&&(f="",u[e].isSchool?f="school-icon":u[e].isPublic&&(f="library-icon"),o=`<div aria-label="${r.properties.title}" class="libraryMarkerIcon ${f}"></div>`);var c=`<div style="width: 34px; height: 41px;">
                                <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 25.5 30.75">
                                    <path style="fill:#${v};" d="M504.26,293a10.28,10.28,0,0,1-3-7.31,10,10,0,1,1,20,0,10.29,10.29,0,0,1-2.75,7l-.28.3-6.95,7.22Z" transform="translate(-499 -273)"/>
                                    <path style="fill:#fff" d="M511.22,276a9.6,9.6,0,0,1,9.48,9.72,9.82,9.82,0,0,1-2.62,6.69h0l-.05.05-.22.23-1.7,1.76-4.9,5.1-4.9-5.1-1.7-1.76a9.82,9.82,0,0,1-2.88-7,9.6,9.6,0,0,1,9.48-9.72m0-1a10.61,10.61,0,0,0-10.48,10.72,10.77,10.77,0,0,0,3.17,7.67l1.69,1.75,4.9,5.09.72.75.72-.75,4.9-5.09,1.7-1.77.23-.24,0,0-.06-.06.06.06a10.81,10.81,0,0,0,2.89-7.37A10.61,10.61,0,0,0,511.22,275Z" transform="translate(-499 -273)"/>
                                </svg>
                                ${o}
                            </div> `,l=L.popup({closeButton:!1,className:"branch-pin-container"}),h=L.marker(r.geometry.coordinates,{data:{id:r.properties.id,markerColor:s.markerColor,consortiumId:r.properties.consortiumId},icon:L.divIcon({className:"branch-pin",html:c,iconSize:[34,41],iconAnchor:[17,41]}),keyboard:!1}).bindPopup(l,{offset:new L.Point(0,-24)}).on("click",function(n){nt(n.target,n.target.options.consortiumId,n.target.options.data.id,!1)});r.index=s.markers.push(h)-1;t.cluster?s.cluster.addLayer(h):n.addLayer(h)}}),r[u[e].consortiumId]=s,c=null;if(t.render&&t.render(u,nt,o?"location":"name",i),(!o||i=="query search")&&u.length>0&&(i!="move end"||it)){if(l=u[0].geoJson[0].geometry.coordinates[0],a=u[0].geoJson[0].geometry.coordinates[1],it=!1,l===0&&a===0){f("/mapbox/could-not-locate/");return}h(l,a,{autoSize:!0,minHitCount:20})}})},kt=function(n,t){return n+","+t},dt=function(n){var t=n.getCenter();return kt(t.lat,t.lng)},gt=function(n){var t=n.getBounds(),i=v(t.getNorth()),r=v(t.getSouth()),e=v(t.getWest()),o=v(t.getEast()),u=(o-e)*Math.cos((i+r)/2),f=r-i,s=Math.sqrt(u*u+f*f)*3959;return Math.ceil(s/2)},v=function(n){return n*(Math.PI/180)},ni=function(){var n=[Math.random()*255<<0,Math.random()*255<<0,Math.random()*255<<0],t,i;return n[0]>127&&n[1]>127&&n[2]>127&&(t=Math.random()*3<<0,n[t]=n[t]/2<<0),i=("00"+n[0].toString(16)+" ").slice(-3,-1)+("00"+n[1].toString(16)+" ").slice(-3,-1)+("00"+n[2].toString(16)+" ").slice(-3,-1),"#"+i},ti=function(n){var i={markerColor:ni(),markers:[],containsMarker:ui};return t.cluster&&(i.cluster=new L.MarkerClusterGroup,n.addLayer(i.cluster)),i},ii=function(n,t,i){$.get("/mapbox/popup-content/"+t+"?markerColor="+i.substr(1,6),{_:$.now()},function(t){var r=$("<div><\/div>").append(t),i=r.find('a[data-action="save"], a[data-action="delete"]');i.click(function(n){n.preventDefault();var t=i.data("action")=="save",r=t?"/user-libraries/add-library/"+i.data("library-id"):"/user-libraries/remove-library/"+i.data("library-id");i.attr("disabled","disabled");$.ajax({type:"POST",url:r,data:{}}).done(function(){i.data("action",t?"delete":"save").text(t?"Delete library":"Save library")}).always(function(){i.removeAttr("disabled")})});n.setContent(r[0])})},ri=function(n){return L.latLngBounds(L.latLng(n.maxLat,n.minLng),L.latLng(n.minLat,n.maxLng))},ui=function(n){for(var t=0;t<this.markers.length;t++)if(this.markers[t].getLatLng().equals(n.geometry.coordinates))return!0;return!1},fi=function(){return i},ei=function(){return p},f=function(n){window.OverDrive.usingV2LibrariesPage&&window.OverDrive.usingV2LibrariesPage===!0?($(".no-libraries-found-container").show(),$(".see-more-consortium").hide(),$(".sort-container").hide(),$(".map-key-contents").empty()):$.get(n,function(n){u!=null&&(u.remove(),u=null);u=$($.parseHTML(n));u.find("button").click(function(){u.remove();u=null});e.parent().append(u)})};return{initialize:et,disable:vt,enable:yt,getUserLocation:ut,setView:h,minHitCount:a,getMap:fi,getBounds:ei,showPopup:nt,displayErrorMessage:f,mergeOptions:bt,executeSearch:rt}}